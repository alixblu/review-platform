services:
  neo4j:
    image: neo4j:5.23
    container_name: neo4j
    environment:
      - NEO4J_AUTH=neo4j/12345678
      - NEO4J_dbms_security_auth__enabled=true
      - NEO4J_server_memory_heap_initial__size=512m
      - NEO4J_server_memory_heap_max__size=1g
    ports:
      - "7474:7474"
      - "7687:7687"
    volumes:
      - neo4j-data:/data
      - neo4j-logs:/logs

  postgres-product:
    image: ankane/pgvector
    container_name: postgres_product
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=12345
      - POSTGRES_DB=product-service
    ports:
      - "5432:5432"
    volumes:
      - pgproduct-data:/var/lib/postgresql/data

  postgres-post:
    image: ankane/pgvector
    container_name: postgres_post
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=12345
      - POSTGRES_DB=post-service
    ports:
      - "5433:5432"
    volumes:
      - pgpost-data:/var/lib/postgresql/data

  postgres-admin:
    image: postgres:16
    container_name: postgres_admin
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=12345
      - POSTGRES_DB=admin-service
    ports:
      - "5434:5432"
    volumes:
      - pgadmin-data:/var/lib/postgresql/data

  auth-service:
    build:
      context: ./review-platform
      dockerfile: auth-service/Dockerfile
    container_name: auth_service
    ports:
      - "8080:8080"
    environment:
      - SERVER_PORT=8080
      - SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_COGNITO_CLIENT-SECRET=${COGNITO_CLIENT_SECRET}
      - USER_SERVICE_URL=http://user-service:8081/api
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL:-http://localhost:8080}
    depends_on: []

  user-service:
    build:
      context: ./review-platform
      dockerfile: user-service/Dockerfile
    container_name: user_service
    ports:
      - "8081:8081"
    environment:
      - SERVER_PORT=8081
      - SPRING_NEO4J_URI=bolt://neo4j:7687
      - SPRING_NEO4J_AUTHENTICATION_USERNAME=neo4j
      - SPRING_NEO4J_AUTHENTICATION_PASSWORD=12345678
    depends_on:
      - neo4j

  product-service:
    build:
      context: ./review-platform
      dockerfile: product-service/Dockerfile
    container_name: product_service
    ports:
      - "8082:8082"
    environment:
      - SERVER_PORT=8082
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-product:5432/product-service
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=12345
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_ACCESS_KEY_ID_PROD=${AWS_ACCESS_KEY_ID_PROD}
      - AWS_SECRET_ACCESS_KEY_PROD=${AWS_SECRET_ACCESS_KEY_PROD}
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
    depends_on:
      - postgres-product

  post-service:
    build:
      context: ./review-platform
      dockerfile: post-service/Dockerfile
    container_name: post_service
    ports:
      - "8083:8083"
    environment:
      - SERVER_PORT=8083
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-post:5432/post-service
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=12345
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - PRODUCT_SERVICE_URL=http://product-service:8082/api/product
    depends_on:
      - postgres-post

  admin-service:
    build:
      context: ./review-platform
      dockerfile: admin-service/Dockerfile
    container_name: admin_service
    ports:
      - "8084:8084"
    environment:
      - SERVER_PORT=8084
      - SPRING_DATASOURCE_URL=jdbc:postgresql://postgres-admin:5432/admin-service
      - SPRING_DATASOURCE_USERNAME=postgres
      - SPRING_DATASOURCE_PASSWORD=12345
    depends_on:
      - postgres-admin

  api-gateway:
    build:
      context: ./review-platform
      dockerfile: api-gateway/Dockerfile
    container_name: api_gateway
    ports:
      - "8888:8888"
    environment:
      - SPRING_PROFILES_ACTIVE=docker
      - FRONTEND_URL=${FRONTEND_URL:-http://localhost:3000}
    depends_on:
      - auth-service
      - user-service
      - product-service

  frontend:
    build:
      context: ./review-platform-fe
      dockerfile: Dockerfile
      args:
        VITE_API_URL: ${VITE_API_URL:-http://localhost:8888}
        VITE_APP_URL: ${VITE_APP_URL:-http://localhost:3000}
        VITE_COGNITO_DOMAIN: ${VITE_COGNITO_DOMAIN:-https://us-east-1jhi5wpbs9.auth.us-east-1.amazoncognito.com}
        VITE_COGNITO_CLIENT_ID: ${VITE_COGNITO_CLIENT_ID:-62te3nhct6ltri9o1acf44n5b5}
    container_name: review_frontend
    ports:
      - "3000:80"
    depends_on:
      - api-gateway

volumes:
  neo4j-data: {}
  neo4j-logs: {}
  pgproduct-data: {}
  pgpost-data: {}
  pgadmin-data: {}


